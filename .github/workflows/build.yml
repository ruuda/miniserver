name: "Build"

on:
  - "push"

jobs:
  build:
    runs-on: "ubuntu-18.04"
    steps:
      - uses: "actions/checkout@v2"

      - name: "Install build dependencies"
        run: "./install-nix.sh"

      - name: "Build"
        run: "nix build --out-link miniserver.img"

      - name: "Print reproducibility metadata"
        run: "sha256sum miniserver.img"

      - name: "Dry-run Nginx"
        run: "systemd-nspawn --image miniserver.img --ephemeral -- /usr/bin/nginx -V"

      - uses: "actions/upload-artifact@v2"
        with:
          name: "miniserver.img"
          path: "miniserver.img"
